---
layout: post
category : web
title: 'æ¸è¿›å¼Webåº”ç”¨'
tagline: ""
tags : [web]
---

## æ¸è¿›å¼Webåº”ç”¨

- å®‰å…¨ â€“ é€šè¿‡ HTTPS æ¥æä¾›æœåŠ¡æ¥é˜²æ­¢ç½‘ç»œçª¥æ¢ï¼Œä¿è¯å†…å®¹ä¸è¢«ç¯¡æ”¹ã€‚

- æ¸è¿›å¼ â€“ èƒ½å¤Ÿè®©æ¯ä¸€ä½ç”¨æˆ·ä½¿ç”¨ï¼Œæ— è®ºç”¨æˆ·ä½¿ç”¨ä»€ä¹ˆæµè§ˆå™¨ï¼Œå› ä¸ºå®ƒæ˜¯å§‹ç»ˆä»¥æ¸è¿›å¢å¼ºä¸ºåŸåˆ™

- å“åº”å¼ â€“ é€‚åº”ä»»ä½•ç¯å¢ƒï¼šæ¡Œé¢ç”µè„‘ã€æ™ºèƒ½æ‰‹æœºã€å¹³æ¿ç”µè„‘ï¼Œæˆ–è€…å…¶ä»–è®¾å¤‡ã€‚

- ä¸ä¾èµ–ç½‘ç»œè¿æ¥ â€“ é€šè¿‡ç”¨ service workers å¢å¼ºï¼Œå¯ä»¥åœ¨ç¦»çº¿æˆ–è€…ä½è´¨é‡ç½‘ç»œä¸‹å·¥ä½œ

- ç±»åŸç”Ÿåº”ç”¨ â€“ æœ‰åƒåŸç”Ÿåº”ç”¨èˆ¬çš„äº¤äº’å’Œå¯¼èˆªç»™ç”¨æˆ·åŸç”Ÿåº”ç”¨èˆ¬çš„ä½“éªŒï¼Œå› ä¸ºå®ƒæ˜¯å»ºç«‹åœ¨ app shell model ä¸Šçš„ã€‚

- æŒç»­æ›´æ–° â€“ å—ç›Šäº service worker çš„æ›´æ–°è¿›ç¨‹ï¼Œåº”ç”¨èƒ½å¤Ÿå§‹ç»ˆä¿æŒæ›´æ–°ã€‚

- å¯å‘ç° â€“ å¯è¯†åˆ«ä¸ºâ€œåº”ç”¨ç¨‹åºâ€ï¼Œæ˜¯å¾—ç›Šäº W3C manifests å…ƒæ•°æ®å’Œ service worker çš„ç™»è®°ï¼Œè®©æœç´¢å¼•æ“èƒ½å¤Ÿæ‰¾åˆ° web åº”ç”¨ã€‚

- å¯å†æ¬¡è®¿é—® â€“ é€šè¿‡æ¨é€é€šçŸ¥ç­‰ç‰¹æ€§è®©ç”¨æˆ·å†æ¬¡è®¿é—®å˜å¾—å®¹æ˜“ã€‚

- å¯å®‰è£… â€“ å…è®¸ç”¨æˆ·ä¿ç•™å¯¹ä»–ä»¬æœ‰ç”¨çš„åº”ç”¨åœ¨ä¸»å±å¹•ä¸Šï¼Œä¸éœ€è¦é€šè¿‡åº”ç”¨å•†åº—ã€‚

- å¯é“¾æ¥ â€“ é€šè¿‡ URL å¯ä»¥è½»æ¾åˆ†äº«åº”ç”¨ï¼Œä¸ç”¨å¤æ‚çš„å®‰è£…å³å¯è¿è¡Œã€‚

<!--break-->

å¦‚ä½•è®©ä½ çš„åº”ç”¨ç¨‹åºèƒ½å¤Ÿç¦»çº¿å·¥ä½œï¼Ÿ

å¦‚ä½•å­˜å‚¨æ•°æ®ä»¥åœ¨ç¦»çº¿æ—¶ä½¿ç”¨ï¼Ÿ

## Service Worker æ˜¯ä»€ä¹ˆï¼Ÿ

service worker æ˜¯ç‹¬ç«‹äºå½“å‰é¡µé¢çš„ä¸€æ®µè¿è¡Œåœ¨æµè§ˆå™¨åå°è¿›ç¨‹é‡Œçš„è„šæœ¬ã€‚service workerä¸éœ€è¦ç”¨æˆ·æ‰“å¼€ web é¡µé¢ï¼Œä¹Ÿä¸éœ€è¦å…¶ä»–äº¤äº’ï¼Œå¼‚æ­¥åœ°è¿è¡Œåœ¨ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¸ä¼šå¯¹ä¸»çº¿ç¨‹é€ æˆé˜»å¡ã€‚åŸºäºservice workerå¯ä»¥å®ç°æ¶ˆæ¯æ¨é€ï¼Œé™é»˜æ›´æ–°ä»¥åŠåœ°ç†å›´æ ç­‰æœåŠ¡ã€‚service workeræä¾›ä¸€ç§æ¸è¿›å¢å¼ºçš„ç‰¹æ€§ï¼Œä½¿ç”¨ç‰¹æ€§æ£€æµ‹æ¥æ¸æ¸å¢å¼ºï¼Œä¸ä¼šåœ¨è€æ—§çš„ä¸æ”¯æŒ service workers çš„æµè§ˆå™¨ä¸­äº§ç”Ÿå½±å“ã€‚

æ ¸å¿ƒç‰¹å¾æ˜¯èƒ½æ‹¦æˆªå’Œå¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œå¯ç¼–ç¨‹ç®¡ç†å“åº”çš„ç¼“å­˜ã€‚

æ³¨æ„äº‹é¡¹ï¼š

1.service workerè¿è¡Œåœ¨å®ƒä»¬è‡ªå·±çš„å®Œå…¨ç‹¬ç«‹å¼‚æ­¥çš„å…¨å±€ä¸Šä¸‹æ–‡ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬æœ‰è‡ªå·±çš„å®¹å™¨ã€‚

2.service workeræ²¡æœ‰ç›´æ¥æ“ä½œDOMçš„æƒé™ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡postMessageæ–¹æ³•æ¥ä¸Webé¡µé¢é€šä¿¡ï¼Œè®©é¡µé¢æ“ä½œDOMã€‚

3.service workeræ˜¯ä¸€ä¸ªå¯ç¼–ç¨‹çš„ç½‘ç»œä»£ç†ï¼Œå…è®¸å¼€å‘è€…æ§åˆ¶é¡µé¢ä¸Šå¤„ç†çš„ç½‘ç»œè¯·æ±‚ã€‚

4.æµè§ˆå™¨å¯èƒ½éšæ—¶å›æ”¶service workerï¼Œåœ¨ä¸è¢«ä½¿ç”¨çš„æ—¶å€™ï¼Œå®ƒä¼šè‡ªå·±ç»ˆæ­¢ï¼Œè€Œå½“å®ƒå†æ¬¡è¢«ç”¨åˆ°çš„æ—¶å€™ï¼Œä¼šè¢«é‡æ–°æ¿€æ´»ã€‚

5.service workerçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ç”±äº‹ä»¶é©±åŠ¨çš„è€Œä¸æ˜¯é€šè¿‡Clientã€‚

### Service Workerç”Ÿå‘½å‘¨æœŸ

service workeræ‹¥æœ‰ä¸€ä¸ªå®Œå…¨ç‹¬ç«‹äºWebé¡µé¢çš„ç”Ÿå‘½å‘¨æœŸ

![sw-lifecycle.png](/images/201703/sw-lifecycle.png)

1. æ³¨å†Œservice workerï¼Œåœ¨ç½‘é¡µä¸Šç”Ÿæ•ˆ

2. å®‰è£…æˆåŠŸï¼Œæ¿€æ´» æˆ–è€… å®‰è£…å¤±è´¥ï¼ˆä¸‹æ¬¡åŠ è½½ä¼šå°è¯•é‡æ–°å®‰è£…ï¼‰

3. æ¿€æ´»åï¼Œåœ¨swçš„ä½œç”¨åŸŸä¸‹ä½œç”¨æ‰€æœ‰çš„é¡µé¢ï¼Œé¦–æ¬¡æ§åˆ¶swä¸ä¼šç”Ÿæ•ˆï¼Œä¸‹æ¬¡åŠ è½½é¡µé¢æ‰ä¼šç”Ÿæ•ˆã€‚

4. swä½œç”¨é¡µé¢åï¼Œå¤„ç†fetchï¼ˆç½‘ç»œè¯·æ±‚ï¼‰å’Œmessageï¼ˆé¡µé¢æ¶ˆæ¯ï¼‰äº‹ä»¶ æˆ–è€… è¢«ç»ˆæ­¢ï¼ˆèŠ‚çœå†…å­˜ï¼‰ã€‚

### Service Workeræ”¯æŒä½¿ç”¨

#### æµè§ˆå™¨æ”¯æŒ

[service worker support](https://jakearchibald.github.io/isserviceworkerready/)

![navigator-serviceworker.png](/images/201703/navigator-serviceworker.png)

#### polyfill

ä½¿ç”¨[ServiceWorker cache polyfill](https://github.com/dominiccooney/cache-polyfill)è®©æ—§ç‰ˆæœ¬æµè§ˆå™¨æ”¯æŒ ServiceWorker cache APIï¼Œ

#### https

Serveréœ€è¦æ”¯æŒhttps

é€šè¿‡service workerå¯ä»¥åŠ«æŒè¿æ¥ï¼Œä¼ªé€ å’Œè¿‡æ»¤å“åº”ï¼Œä¸ºäº†é¿å…è¿™äº›é—®é¢˜ï¼Œåªèƒ½åœ¨HTTPSçš„ç½‘é¡µä¸Šæ³¨å†Œservice workersï¼Œé˜²æ­¢åŠ è½½service workerçš„æ—¶å€™ä¸è¢«åäººç¯¡æ”¹ã€‚

Github Pagesæ˜¯HTTPSçš„ï¼Œå¯ä»¥é€šè¿‡Githubåšä¸€äº›å°è¯•

### è°ƒè¯•å·¥å…·

åœ¨è°ƒè¯•çš„æ—¶å€™å¯ä»¥ç”¨äºunregisterã€stopã€startç­‰æ“ä½œ

chromeè®¿é—®`chrome://inspect/#service-workers`æˆ–`chrome://serviceworker-internals`æŸ¥çœ‹service-workers

![chrome-tool-1.png](/images/201703/chrome-tool-1.png)

![chrome-tool-2.png](/images/201703/chrome-tool-2.png)

firefoxé€šè¿‡`about:debugging#workers`æŸ¥çœ‹

![firefox-tool.png](/images/201703/firefox-tool.png)

æ›´å¤šè¯·å‚è€ƒ[debugging-service-workers](https://developers.google.com/web/fundamentals/getting-started/codelabs/debugging-service-workers/)

## ç¦»çº¿å­˜å‚¨æ•°æ®

å¯¹URLå¯»å€èµ„æºï¼Œä½¿ç”¨[Cache API](https://davidwalsh.name/cache)ã€‚å¯¹å…¶ä»–æ•°æ®ï¼Œä½¿ç”¨IndexedDBã€‚

## ç¦»çº¿é˜…è¯»

### demo

ä½¿ç”¨[https](https://2017/02/27/pwa)è®¿é—®æœ¬æ–‡ï¼Œæ‰“å¼€ChromeDevToolsï¼Œé€‰æ‹©Applicationé€‰é¡¹å¡->Service Workers

![sw-devtools.png](/images/201703/sw-devtools.png)

å¯ä»¥çœ‹åˆ°Service Workersæ³¨å†Œ

ç‚¹å‡»ä¸‹é¢ç¦»çº¿ä¿å­˜æŒ‰é’®

<button class="btn btn-sm btn-primary offline-btn">ç¦»çº¿ä¿å­˜</button>

ç„¶åé€‰æ‹©Cache Storageï¼Œå¯ä»¥çœ‹åˆ°æ–‡å­—å†…å®¹å·²ç»ç¼“å­˜åˆ°Cache Storage

![sw-cache.png](/images/201703/sw-cache.png)

ç„¶åé€‰æ‹©Service Workers å‹¾é€‰ Offlineï¼ŒNetWorkå‡ºç°äº†âš ï¸ï¸ï¼Œç„¶åè¯•è¯•ç¦»çº¿è®¿é—®æœ¬æ–‡ğŸ˜

![sw-offline.png](/images/201703/sw-offline.png)

### åŸç†

#### æ³¨å†Œ service worker

åˆ›å»ºä¸€ä¸ª JavaScript æ–‡ä»¶ï¼ˆæ¯”å¦‚ï¼šsw.jsï¼‰ä½œä¸º service worker

å‘Šè¯‰æµè§ˆå™¨æ³¨å†Œè¿™ä¸ªJavaScriptæ–‡ä»¶ä¸ºservice workerï¼Œæ£€æŸ¥service worker APIæ˜¯å¦å¯ç”¨ï¼Œå¦‚æœå¯ç”¨å°±æ³¨å†Œservice worker

```
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(function(registration) {
    // Registration was successful
    console.log('ServiceWorker registration successful with scope: ',    registration.scope);
  }).catch(function(err) {
    // registration failed :(
    console.log('ServiceWorker registration failed: ', err);
  });
}
```

sw.jsæ–‡ä»¶è¢«æ”¾åœ¨è¿™ä¸ªåŸŸçš„æ ¹ç›®å½•ä¸‹ï¼Œå’Œç½‘ç«™åŒæºã€‚è¿™ä¸ªservice workå°†ä¼šæ”¶åˆ°è¿™ä¸ªåŸŸä¸‹çš„æ‰€æœ‰fetchäº‹ä»¶ã€‚

å¦‚æœå°†service workeræ–‡ä»¶æ³¨å†Œä¸º/example/sw.jsï¼Œé‚£ä¹ˆï¼Œservice workeråªèƒ½æ”¶åˆ°/example/è·¯å¾„ä¸‹çš„fetchäº‹ä»¶ï¼ˆä¾‹å¦‚ï¼š /example/page1/, /example/page2/ï¼‰ã€‚

#### ç¼“å­˜ç«™ç‚¹çš„èµ„æº

å®šä¹‰éœ€è¦ç¼“å­˜çš„æ–‡ä»¶ï¼Œç„¶ååœ¨swæ³¨å†Œå®‰è£…åå›åˆ°cache Apiå°†èµ„æºæ–‡ä»¶å†™å…¥ç¼“å­˜ã€‚å¦‚æœæ‰€æœ‰çš„æ–‡ä»¶éƒ½è¢«ç¼“å­˜æˆåŠŸäº†ï¼Œé‚£ä¹ˆservice workerå°±å®‰è£…æˆåŠŸäº†ã€‚å¦‚æœä»»ä½•ä¸€ä¸ªæ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œé‚£ä¹ˆå®‰è£…æ­¥éª¤å°±ä¼šå¤±è´¥ã€‚

```
var cacheName = 'v1';
var assetsToCache = [
  '/styles/main.css',
  '/script/main.js'
];

self.addEventListener('install', function(event) {
  event.waitUntil(
    caches.open(cacheName).then(function(cache) {
      return cache.addAll(assetsToCache);
    }).then(function() {
      return self.skipWaiting();
    })
  );
});
```

#### ä»ç¼“å­˜ä¸­åŠ è½½

service workeræˆåŠŸæ³¨å†Œï¼Œå¹¶ä¸”ç”¨æˆ·æµè§ˆäº†å¦ä¸€ä¸ªé¡µé¢æˆ–è€…åˆ·æ–°äº†å½“å‰çš„é¡µé¢ï¼Œservice workerå°†å¼€å§‹æ¥æ”¶åˆ°fetchäº‹ä»¶ã€‚

æ‹¦æˆªç½‘ç»œè¯·æ±‚å¹¶ä½¿ç”¨ç¼“å­˜ï¼Œç¼“å­˜å‘½ä¸­ï¼Œè¿”å›ç¼“å­˜èµ„æºï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªå®æ—¶ä»ç½‘ç»œè¯·æ±‚fetchçš„ç»“æœã€‚

```
self.addEventListener('fetch', function(event) {
  var requestUrl = new URL(event.request.url);
  if (requestUrl.origin === location.origin) {
      if (requestUrl.pathname === '/') {
      event.respondWith(
        caches.open(cacheName).then(function(cache) {
          return fetch(event.request).then(function(networkResponse) {
            cache.put(event.request, networkResponse.clone());
            return networkResponse;
          }).catch(function() {
            return cache.match(event.request);
          });
        })
      );
    }
  }

  event.respondWith(
    caches.match(event.request).then(function(response) {
      return response || fetch(event.request);
    })
  );
});
```

#### ç¼“å­˜ç‰ˆæœ¬ç®¡ç†

ç‰ˆæœ¬ä¿®æ”¹çš„æ—¶å€™ä¼šè§¦å‘activateï¼Œå°†æ—§ç‰ˆæœ¬çš„ç¼“å­˜æ¸…ç†æ‰ã€‚

```
var OFFLINE_PREFIX = 'offline-';
var CACHE_NAME = 'main_v1.0.0';
self.addEventListener('activate', function(event) {
  var mainCache = [CACHE_NAME];
  event.waitUntil(
    caches.keys().then(function(cacheNames) {
      return Promise.all(
        cacheNames.map(function(cacheName) {
          if ( mainCache.indexOf(cacheName) === -1 && cacheName.indexOf(OFFLINE_PREFIX) === -1 ) {
            // When it doesn't match any condition, delete it.
            console.info('SW: deleting ' + cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
  return self.clients.claim();
});
```

## Service Worker åº“

- [sw-toolbox](https://github.com/GoogleChrome/sw-toolbox)

- [sw-precache](https://github.com/GoogleChrome/sw-precache)

- [offline-plugin](https://github.com/NekR/offline-plugin)ï¼Œwebpackç¦»çº¿æ’ä»¶

## å‚è€ƒ

- [progressive-web-apps](https://developers.google.com/web/progressive-web-apps/)

- [your-first-pwapp](https://developers.google.com/web/fundamentals/getting-started/codelabs/your-first-pwapp/)

- [service-workers](https://developers.google.com/web/fundamentals/getting-started/primers/service-workers)

- [ä¸‹ä¸€ä»£ Web åº”ç”¨æ¨¡å‹ â€”â€” Progressive Web App](http://geek.csdn.net/news/detail/135595)

- [å…³äºæ¸è¿›å¼ Web åº”ç”¨ï¼Œä½ åº”è¯¥çŸ¥é“çš„ä¸€åˆ‡](http://www.zcfy.cc/article/everything-you-should-know-about-progressive-web-apps-tutorialzine-2047.html)

- [ä½ éœ€è¦å¼€å‘PWAåº”ç”¨å—ï¼Ÿ](http://mp.weixin.qq.com/s?__biz=MzI5MDM2NjY5Nw==&mid=2247484043&idx=1&sn=0a93b2f32c2d80f43e2579fb56074a1f&chksm=ec21b70ddb563e1bd01a8acf4fbce8aeb0dc35f1110f7f004e3228d9b18605b3aaf7affa496b&mpshare=1&scene=1&srcid=0115m8O4xYwWYNZHgxmoZFe2#rd)

- [æ¸è¿›å¼ Web App çš„ç¦»çº¿å­˜å‚¨](https://segmentfault.com/a/1190000006640450)

<script src="/assets/themes/twitter/js/offline-sw.js"></script>